name: ops_daily

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      mode:
        description: "Run mode (ci or prod)"
        required: true
        default: "ci"
        type: choice
        options:
          - ci
          - prod

permissions:
  contents: read
  issues: write

jobs:
  ops_daily:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f backend/requirements.txt ]; then
            python -m pip install -r backend/requirements.txt
          elif [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi
          python -m pip install pyyaml

      - name: Policy check
        run: python3 tools/policy_check.py

      - name: Prod config contract (scheduled runs)
        if: ${{ github.event_name == 'schedule' }}
        env:
          POSTGRES_DSN_PROD: ${{ secrets.POSTGRES_DSN_PROD }}
        run: |
          set +e
          OUTPUT="$(PYTHONPATH=backend:. python3 -m tools.prod_config_contract --mode=prod_required 2>&1)"
          EXIT_CODE=$?
          echo "$OUTPUT"
          if [ "$EXIT_CODE" != "0" ]; then
            echo "prod_config missing_env: set required secrets (names only) in repo settings." >> "$GITHUB_STEP_SUMMARY"
            exit $EXIT_CODE
          fi

      - name: Run ops_daily
        continue-on-error: true
        env:
          POSTGRES_DSN: ${{ secrets.POSTGRES_DSN_PROD }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          MODE="${{ github.event.inputs.mode || '' }}"
          if [ -z "$MODE" ]; then
            MODE="prod"
          fi
          if [ "$MODE" = "prod" ]; then
            if [ -z "$POSTGRES_DSN" ]; then
              echo "mode=smoke reason=prod_not_configured"
              PYTHONPATH=backend:. python3 -m tools.ops_daily smoke
              exit 0
            fi
            echo "mode=strict reason=prod_configured"
            set +e
            OUTPUT="$(PYTHONPATH=backend:. python3 -m tools.ops_daily all 2>&1)"
            EXIT_CODE=$?
            echo "$OUTPUT" | tee ops_daily.log
            TAIL="$(echo "$OUTPUT" | tail -n 20)"
            MODE_LINE="$(echo "$OUTPUT" | grep -m 1 "mode=strict reason=prod_configured" || true)"
            echo "strict_run=1" >> "$GITHUB_OUTPUT"
            echo "ops_exit=$EXIT_CODE" >> "$GITHUB_OUTPUT"
            echo "ops_tail<<'EOF'" >> "$GITHUB_OUTPUT"
            echo "$TAIL" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "ops_mode_line<<'EOF'" >> "$GITHUB_OUTPUT"
            echo "$MODE_LINE" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          PYTHONPATH=backend:. python3 -m tools.ops_daily smoke
        id: run_ops

      - name: Normalize strict exit code
        if: ${{ always() && steps.run_ops.outputs.strict_run == '1' }}
        run: |
          OPS_EXIT="${{ steps.run_ops.outputs.ops_exit }}"
          if [ "${{ github.event_name }}" != "schedule" ]; then
            LINE="ops_ci_normalize status=skip reason=not_schedule"
            echo "$LINE"
            echo "normalized_exit=$OPS_EXIT" >> "$GITHUB_OUTPUT"
            echo "normalized_line=$LINE" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          set +e
          OUTPUT="$(PYTHONPATH=backend:. python3 -m tools.ops_ci_normalize --exit-code "$OPS_EXIT" --log-file ops_daily.log 2>&1)"
          NORMAL_EXIT=$?
          echo "$OUTPUT"
          echo "normalized_exit=$NORMAL_EXIT" >> "$GITHUB_OUTPUT"
          echo "normalized_line=$OUTPUT" >> "$GITHUB_OUTPUT"
          if [ "$NORMAL_EXIT" = "0" ] && echo "$OUTPUT" | grep -q "status=normalized"; then
            echo "Normalized insufficient_data in scheduled run." >> "$GITHUB_STEP_SUMMARY"
          elif [ "$NORMAL_EXIT" = "0" ]; then
            echo "ops_daily strict completed successfully." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "ops_daily strict failed (exit_code=$NORMAL_EXIT)." >> "$GITHUB_STEP_SUMMARY"
          fi
          exit 0
        id: normalize_ops

      - name: Create or update ops_daily issue (strict failures)
        if: ${{ always() && steps.run_ops.outputs.strict_run == '1' && steps.normalize_ops.outputs.normalized_exit != '0' }}
        uses: actions/github-script@v7
        with:
          script: |
            const title = "ops_daily strict unhealthy";
            const bodyLines = [
              "ops_daily strict failure detected.",
              `timestamp=${new Date().toISOString()}`,
              `run_url=${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`,
              `exit_code=${process.env.OPS_EXIT}`,
              process.env.OPS_MODE_LINE ? `mode_line=${process.env.OPS_MODE_LINE}` : "mode_line=missing",
              process.env.OPS_NORMALIZED_LINE ? `normalize_line=${process.env.OPS_NORMALIZED_LINE}` : "normalize_line=missing",
              "",
              "ops_daily_output_tail:",
              "```",
              process.env.OPS_TAIL || "",
              "```",
            ];
            const body = bodyLines.join("\n");
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100,
            });
            const existing = issues.find((issue) => issue.title === title);
            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body,
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
              });
            }
        env:
          OPS_EXIT: ${{ steps.run_ops.outputs.ops_exit }}
          OPS_TAIL: ${{ steps.run_ops.outputs.ops_tail }}
          OPS_MODE_LINE: ${{ steps.run_ops.outputs.ops_mode_line }}
          OPS_NORMALIZED_LINE: ${{ steps.normalize_ops.outputs.normalized_line }}

      - name: Notify Slack (strict failures, optional)
        if: ${{ always() && steps.run_ops.outputs.strict_run == '1' && steps.normalize_ops.outputs.normalized_exit != '0' && env.SLACK_WEBHOOK_URL != '' }}
        env:
          OPS_EXIT: ${{ steps.run_ops.outputs.ops_exit }}
        run: |
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          SUMMARY="ops_daily strict unhealthy (exit_code=${OPS_EXIT})"
          payload=$(cat <<EOF
          {"text":"${SUMMARY} ${RUN_URL}"}
          EOF
          )
          curl -sS -X POST -H "Content-type: application/json" --data "$payload" "$SLACK_WEBHOOK_URL" >/dev/null

      - name: Fail workflow on strict unhealthy
        if: ${{ always() && steps.run_ops.outputs.strict_run == '1' && steps.normalize_ops.outputs.normalized_exit != '0' }}
        run: exit ${{ steps.normalize_ops.outputs.normalized_exit }}
