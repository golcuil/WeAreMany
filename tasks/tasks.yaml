- id: T-001
  title: Wire policy_check into CI gate
  owner: cto
  state: DONE
  goal: CI blocks merges when policy_check fails
  scope:
    in:
    - Add policy_check step to CI workflow
    - Document required checks in CI
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - CI runs policy_check on PRs and main pushes
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Policy check script returns non-zero on violations
    integration:
    - CI workflow fails on policy_check violation
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Policy drift
    - Guardrail bypass
    mitigations:
    - CI gating
    - Policy check enforced on all branches
- id: T-002
  title: Define backend API contract skeleton
  owner: backend
  state: DONE
  goal: OpenAPI contract defines MVP endpoints and payloads
  scope:
    in:
    - Draft OpenAPI for mood, message, inbox, acknowledgement
    - Define error shapes and auth headers
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies:
  - T-001
  touches:
    endpoints:
    - POST /mood
    - POST /messages
    - GET /inbox
    - POST /acknowledgements
    data:
    - device_id
    - valence
    - intensity
    - emotion
    - free_text
    - sanitized_text
    - risk_level
    - themes
    ai_calls:
    - safety_rewrite
    - theme_extraction
    - risk_classification
  acceptance_criteria:
    functional:
    - Contract lists required fields and response shapes for MVP
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Schema validation rejects unknown fields
    integration:
    - Contract tests for endpoint auth errors and shape compliance
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Enumeration
    - Identity leakage
    mitigations:
    - Non-guessable IDs
    - No sender info fields in responses
- id: T-003
  title: Create MVP data model and migrations
  owner: backend
  state: DONE
  goal: Postgres schema supports mood, message, ack, and events
  scope:
    in:
    - Schema for mood submissions
    - Message storage with sanitized_text only
    - Acknowledgement records
    - Event log table
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies:
  - T-002
  touches:
    endpoints: []
    data:
    - mood
    - message
    - ack
    - events
    - risk_level
    - sanitized_text
    - themes
    ai_calls: []
  acceptance_criteria:
    functional:
    - Migrations create required tables with indexes
    - No sender info stored in message rows
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - DB constraints reject free_text for risk_level==2 records
    integration:
    - Migration runs cleanly on fresh DB
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Re-identification
    - Excessive data retention
    mitigations:
    - Sanitized-only storage
    - Minimal fields
    - No sender info columns
- id: T-004
  title: Implement authn/authz and rate limiting middleware
  owner: sec
  state: DONE
  goal: All endpoints enforce authn/authz and throttles
  scope:
    in:
    - Token auth middleware
    - User-scoped authz checks
    - Per-user/per-IP rate limit policy
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies:
  - T-002
  touches:
    endpoints:
    - POST /mood
    - POST /messages
    - GET /inbox
    - POST /acknowledgements
    data:
    - auth_token
    - device_id
    - rate_limit_bucket
    ai_calls: []
  acceptance_criteria:
    functional:
    - Requests without auth are rejected
    - Cross-user access is blocked
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Auth middleware rejects invalid tokens
    integration:
    - Rate limit returns 429 after threshold
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Account abuse
    - Enumeration
    - API scraping
    mitigations:
    - Authz checks
    - Rate limiting
    - Non-guessable IDs
- id: T-005
  title: Build moderation pipeline skeleton
  owner: sec
  state: DONE
  goal: Risk classification and leak checks gate messaging
  scope:
    in:
    - Risk level classifier stub
    - Leak detection stub
    - Rewrite hook interface
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies:
  - T-002
  - T-003
  touches:
    endpoints:
    - POST /messages
    - POST /mood
    data:
    - free_text
    - sanitized_text
    - risk_level
    - reid_risk
    ai_calls:
    - risk_classification
    - safety_rewrite
  acceptance_criteria:
    functional:
    - risk_level assigned for all submissions
    - risk_level==2 blocks peer messaging
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Identity leak detector flags phone/email/link patterns
    integration:
    - risk_level==2 path bypasses persistence and matching
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Identity leakage
    - Self-harm escalation
    mitigations:
    - Leak detection
    - Risk gating
    - Crisis flow gating
- id: T-006
  title: Implement matching gate and sampling skeleton
  owner: backend
  state: DONE
  goal: Eligible recipients selected without origin info or targeting leakage
  scope:
    in:
    - Match eligibility gates
    - Randomized sampling with caps
    - Cooldown checks
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies:
  - T-003
  - T-005
  touches:
    endpoints:
    - POST /messages
    data:
    - valence
    - intensity
    - themes
    - cooldown
    - affinity_score
    ai_calls: []
  acceptance_criteria:
    functional:
    - Eligible pool excludes risk_level==2
    - No sender info surfaced in delivery
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Eligibility gate rejects incompatible valence/intensity
    integration:
    - Sampling does not return sender info fields
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Targeting
    - Re-identification
    mitigations:
    - Randomized sampling
    - Cooldowns
    - No sender info fields
- id: T-007
  title: Define privacy-safe event taxonomy
  owner: data
  state: DONE
  goal: Event schema captures success metrics without PII
  scope:
    in:
    - Event definitions for mood, message, delivery, acknowledgement
    - Retention notes
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies:
  - T-003
  touches:
    endpoints: []
    data:
    - events
    - risk_level
    - delivery_outcome
    ai_calls: []
  acceptance_criteria:
    functional:
    - Event list excludes raw text and sender info fields
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Event schema rejects raw text fields
    integration:
    - Event writes happen on message delivery and ack
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Re-identification via analytics
    mitigations:
    - No raw text
    - Minimal event fields
    - Retention limits
- id: T-008
  title: Build Flutter app skeleton with Riverpod
  owner: frontend
  state: DONE
  goal: App scaffolding matches Bible navigation and folder structure
  scope:
    in:
    - App shell with tabs
    - Core folder structure
    - Navigation wiring
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies:
  - T-001
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - Tabs align with Home/Messages/Reflection/About
    - No feed or profile UI present
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Navigation state exposes only allowed tabs
    integration:
    - App boots to Home without feed history
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - UI drift into social surfaces
    mitigations:
    - Tab map locked to Bible
    - No sender surfaces
- id: T-009
  title: Implement mood entry flow and crisis UX
  owner: frontend
  state: DONE
  goal: Mood submission triggers crisis UX for risk_level==2
  scope:
    in:
    - Mood input UI
    - Submit to API
    - Crisis screen path
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies:
  - T-002
  - T-008
  touches:
    endpoints:
    - POST /mood
    data:
    - valence
    - intensity
    - emotion
    - risk_level
    ai_calls: []
  acceptance_criteria:
    functional:
    - Mood submit shows crisis UX when risk_level==2
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Crisis screen state triggers on risk_level==2 response
    integration:
    - Mood submit flow handles normal and crisis paths
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Crisis flow bypass
    - Identity exposure in UI
    mitigations:
    - Explicit crisis route
    - No sender info UI
- id: T-010
  title: Implement inbox UI and acknowledgement flow
  owner: frontend
  state: DONE
  goal: Inbox displays one-shot messages with ack options
  scope:
    in:
    - Inbox list UI
    - Message detail state
    - Helpful/seen/not helpful actions
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies:
  - T-002
  - T-008
  touches:
    endpoints:
    - GET /inbox
    - POST /acknowledgements
    data:
    - message_id
    - sanitized_text
    - ack_state
    - timestamp
    ai_calls: []
  acceptance_criteria:
    functional:
    - Inbox shows one-shot messages without sender info
    - Ack locks interaction
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Ack buttons disabled after response
    integration:
    - Inbox does not render sender info fields
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Identity inference
    - Threading creep
    mitigations:
    - One-shot lock
    - No sender info
- id: T-011
  title: Deliver end-to-end happy path
  owner: backend
  state: DONE
  goal: Mood submit -> message send -> inbox receive -> ack works
  scope:
    in:
    - Wire API to data model
    - Use moderation gate in send flow
    - End-to-end integration test
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies:
  - T-003
  - T-004
  - T-005
  - T-006
  - T-008
  - T-009
  - T-010
  touches:
    endpoints:
    - POST /mood
    - POST /messages
    - GET /inbox
    - POST /acknowledgements
    data:
    - mood
    - message
    - ack
    - risk_level
    - sanitized_text
    ai_calls:
    - risk_classification
    - safety_rewrite
    - theme_extraction
  acceptance_criteria:
    functional:
    - Happy path completes without exposing sender info
    - risk_level==2 blocks peer messaging
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Use case enforces one-shot ack lock
    integration:
    - End-to-end flow passes for Level 0 and blocks Level 2
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Cross-user data access
    - Identity leakage
    mitigations:
    - Authz gate
    - Sanitized-only responses
    - Leak detection
- id: T-012
  title: DB-backed eligible recipient pool sampling (theme/intensity buckets)
  owner: backend
  state: DONE
  goal: Replace in-memory candidate pool with a Postgres-backed eligible pool using
    theme/intensity buckets, with cooldown/dedupe and no social-graph reconstruction.
  scope:
    in:
    - Create a table (or view) of eligible principals keyed by principal_key/device_key
      with intensity_bucket, theme_tags, last_active_bucket
    - Add indexes for efficient sampling by intensity_bucket, theme_tag, and recency
      bucket
    - Implement a repository method to fetch N random eligible candidates for a given
      request (no origin fields)
    - Integrate into matching gate so DELIVER works with DB pool when POSTGRES_DSN
      is set
    out:
    - No sender identity persistence
    - No feed/chat/profile/streak features
    - No social graph edges (no storing sender->recipient pairs for analytics)
    - No recipient identifiers returned to clients
  dependencies: []
  touches:
    endpoints:
    - POST /messages
    data:
    - principal_key/device_key
    - intensity_bucket
    - themes/theme_tags
    - last_active_bucket
    ai_calls: []
  acceptance_criteria:
    functional:
    - Candidate selection pulls from DB pool when POSTGRES_DSN is set
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Pool stores no message text; no sender/recipient linkage table
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: selection operates only on server; clients cannot influence recipient_id'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: selection queries do not expose sequential ids; no list endpoints'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Sampling respects intensity/theme gates
    integration:
    - With Postgres enabled, candidate pool is non-empty when eligible principals
      exist
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
    - Cooldown prevents repeated targeting
    - No analytics/event payload includes principal identifiers
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Targeting
    - Re-identification
    - Enumeration
    mitigations:
    - Cooldown/dedupe
    - No recipient IDs returned
    - Non-guessable IDs
- id: T-013
  title: Backend test harness parity (deps + import path)
  owner: backend
  state: BACKLOG
  goal: Ensure pytest runs locally and in CI with consistent import paths and
    dependencies.
  scope:
    in:
    - Ensure backend dependencies are installable in a single command from repo
      root or backend/; document the chosen path
    - Make Python import paths consistent under pytest (backend/app imports resolve)
    - Update CI and local docs/commands to match
    out:
    - No product feature changes
    - No endpoint behavior changes
    - No feed/chat/threads
    - No profiles/identity surfaces
    - No streaks/leaderboards
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - pytest passes locally after the documented install step
    - CI continues to pass without test skips
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN/AuthZ behavior unchanged
    - Rate limiting behavior unchanged
    - Request validation behavior unchanged
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - N/A (harness-only changes)
    integration:
    - pytest succeeds locally with documented setup
    security:
    - No regression in AuthZ and rate-limit tests
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Test environment drift
    - Hidden dependency gaps
    mitigations:
    - Single install command documented
    - Consistent PYTHONPATH/package layout
- id: T-014
  title: Dev-safe rate limiting fallback (no Redis required) + stable iOS Simulator run docs
  owner: backend
  state: DONE
  goal: Avoid Redis-down 500s by falling back to in-memory rate limiting while
    keeping production behavior intact and documenting stable simulator runs.
  scope:
    in:
    - Add an in-memory rate limiter fallback when Redis is not configured or unavailable
    - Ensure fallback preserves per-key window semantics and returns 429 after limits
    - Update README with stable iOS simulator run commands (no device ID hardcoding)
    out:
    - No product feature changes
    - No endpoint behavior changes
    - No sender identity persistence
    - No feed/chat/threads
    - No profiles/identity surfaces
    - No streaks/leaderboards
  dependencies: []
  touches:
    endpoints:
    - GET /version
    - POST /mood
    - POST /messages
    - GET /inbox
    - POST /acknowledgements
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - Redis down does not return 500; fallback limiter applies and returns 429 after limits
    - README includes stable iOS simulator run command and notes device IDs can change
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Redis-down fallback returns non-500 responses
    - Fallback limiter enforces thresholds
    integration:
    - Rate limiting still triggers under abuse
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Abuse via limiter bypass
    - Availability regressions
    mitigations:
    - In-memory fallback with windowed counters
    - Redis error handling without 500s
- id: T-015
  title: Restore CI green on main (deps + import path + psycopg pin)
  owner: backend
  state: DONE
  goal: Fix CI/local parity for backend tests by updating dependency pinning and
    pytest import path consistency without changing product behavior.
  scope:
    in:
    - Update backend dependency pin for psycopg[binary] to an available 3.2.x version
    - Standardize pytest import paths and document the canonical command
    - Align CI to run backend tests before the policy gate with the same command
    out:
    - No product feature changes
    - No endpoint behavior changes
    - No sender identity persistence
    - No feed/chat/threads
    - No profiles/identity surfaces
    - No streaks/leaderboards
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - CI passes with backend tests running before policy gate
    - Local pytest runs with a single documented command
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - N/A (harness-only changes)
    integration:
    - pytest succeeds locally with documented setup
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Test environment drift
    - Dependency resolution failures
    - Import path mismatches
    mitigations:
    - Stable dependency pinning
    - Consistent pytest invocation across CI/local
- id: T-016
  title: CI hygiene cleanup (single source of truth + stable triggers)
  owner: cto
  state: DONE
  goal: Ensure a single canonical CI workflow with stable Flutter and backend
    gates and manual trigger support.
  scope:
    in:
    - Remove redundant CI workflow definitions under .github/workflows
    - Standardize Flutter CI steps and order in the canonical workflow
    - Preserve backend gate order and policy gate placement
    - Keep workflow_dispatch enabled for manual CI runs
    out:
    - No product feature changes
    - No endpoint behavior changes
    - No sender identity persistence
    - No feed/chat/threads
    - No profiles/identity surfaces
    - No streaks/leaderboards
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - Exactly one canonical CI workflow remains and is documented by path
    - Flutter gates run in a consistent order (format, analyze, test)
    - Backend gates run before policy_check
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - N/A (workflow-only changes)
    integration:
    - CI passes with Flutter and backend gates in order
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Gate drift
    - Inconsistent CI triggers
    mitigations:
    - Single canonical workflow
    - Manual trigger enabled
- id: T-018
  title: "Reflection (Tab 3) MVP: Weekly distribution + trend + volatility"
  owner: backend
  state: DONE
  goal: Provide private weekly reflection metrics via backend aggregation and a
    minimal Flutter UI.
  scope:
    in:
    - Persist mood events with safe fields (no text) in Postgres or in-memory
    - Add authenticated reflection summary endpoint for last 7 days
    - Minimal Reflection UI consuming summary endpoint
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies:
  - T-003
  - T-008
  touches:
    endpoints:
    - POST /mood
    - GET /reflection/summary
    data:
    - valence
    - intensity
    - emotion
    - risk_level
    ai_calls: []
  acceptance_criteria:
    functional:
    - Reflection summary returns 7-day distribution, trend, and volatility
    - Mood events persist without storing text, including risk_level==2
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Reflection summary computes distribution and trend from mood events
    integration:
    - Reflection endpoint returns 7-day summary for authenticated user
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Re-identification via analytics
    - Cross-user access
    mitigations:
    - No text persistence
    - Authz gate on summary
- id: T-019
  title: "4-tab bottom nav: Home / Messages / Reflection / Settings (About & Safety inside Settings)"
  owner: frontend
  state: DONE
  goal: Provide canonical bottom navigation and a minimal Settings area with
    About & Safety.
  scope:
    in:
    - Bottom tab navigation with Home, Messages, Reflection, Settings
    - Settings list with About & Safety last
    - About & Safety screen with crisis access
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies:
  - T-008
  - T-018
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - Bottom nav shows 4 tabs and preserves state across switches
    - Profile shows required items with About & Safety last
    - About & Safety opens Crisis resources
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Bottom nav switches between 4 tabs
    integration:
    - About & Safety navigates to Crisis resources
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Identity exposure
    - UI drift into social surfaces
    mitigations:
    - No public profile fields
    - About & Safety scoped copy
- id: T-020
  title: "Align PRD + UX_SPEC with shipped nav (4 tabs + About & Safety placement)"
  owner: pm
  state: DONE
  goal: Update PRD and UX_SPEC to match shipped navigation and safety entry
    points without changing product behavior.
  scope:
    in:
    - UX_SPEC: document 4-tab navigation and About & Safety placement
    - PRD: align navigation and crisis entry points with shipped UI
    - Add explicit safety/privacy statements about anonymity and crisis handling
    out:
    - No bible changes
    - No product feature changes
    - No endpoint behavior changes
    - No social surfaces (feed/chat/threads/public profiles/streaks/leaderboards)
  dependencies:
  - T-019
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - UX_SPEC reflects 4 tabs and About & Safety placement
    - PRD reflects 4 tabs and crisis entry points
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - N/A (docs-only)
    integration:
    - Policy check passes
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Spec drift
    - Safety misinterpretation
    mitigations:
    - Explicit nav map
    - Explicit crisis statements
- id: T-021
  title: Coarsen inbox timestamps (privacy hardening)
  owner: backend
  state: DONE
  goal: Reduce correlation risk by coarsening inbox timestamps while keeping
    response schema stable.
  scope:
    in:
    - Coarsen inbox created_at to day-level UTC in GET /inbox
    - Update inbox display and tests to match coarsened timestamps
    out:
    - No product feature changes
    - No endpoint shape changes
    - No social surfaces (feed/chat/threads/public profiles/streaks/leaderboards)
  dependencies:
  - T-010
  touches:
    endpoints:
    - GET /inbox
    data:
    - created_at
    ai_calls: []
  acceptance_criteria:
    functional:
    - Inbox timestamps are coarsened to day-level UTC and remain ISO strings
    - Inbox ordering remains newest-first
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Inbox created_at is day-coarsened
    integration:
    - Inbox renders coarsened timestamps in UI
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Correlation via timestamps
    mitigations:
    - Day-level coarsening
- id: T-022
  title: CI format diff visibility (print formatter diff on failure)
  owner: cto
  state: IN_PROGRESS
  goal: Show formatter diffs in CI logs when format gate fails, without changing
    product behavior.
  scope:
    in:
    - CI format step prints changed files and diff before failing
    - Keep format gate strict (non-zero exit on diffs)
    out:
    - No app or backend code changes
    - No endpoint behavior changes
    - No social surfaces (feed/chat/threads/public profiles/streaks/leaderboards)
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - CI logs show git status and diff when formatting differs
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - N/A (workflow-only)
    integration:
    - Policy check passes
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - CI gate drift
    - Hidden formatting diffs
    mitigations:
    - Explicit diff output in format step
- id: T-064
  title: Second-touch safety hardening (rate limits + abuse guardrails + tests)
  owner: sec
  state: DONE
  goal: Enforce server-side guardrails for second-touch offers/sends with tests
  scope:
    in:
    - One-shot enforcement for offer_id
    - Per-user monthly cap and per-pair cooldown
    - Disable on negative ack window and PII leak attempts
    - Tests for guardrail enforcement
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints:
    - POST /second_touch/send
    - GET /inbox
    data:
    - second_touch_pairs
    - second_touch_offers
    ai_calls: []
  acceptance_criteria:
    functional:
    - One-shot offer_id enforced server-side
    - Monthly cap and cooldown block offer/send
    - Negative ack disables pair for window
    - Identity leak disables pair permanently
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Guardrail decision tests
    integration:
    - Offer/send blocked by cap/cooldown/negative ack/identity leak
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Harassment via repeated second-touch attempts
    - Identity leak escalation
    mitigations:
    - Server-side caps/cooldowns
    - Pair disable on negative ack/identity leak
- id: T-065
  title: Scheduled ops_daily non-noisy until prod configured
  owner: cto
  state: DONE
  goal: Run scheduled ops_daily in smoke mode unless prod secrets are configured; strict prod preserved.
  scope:
    in:
    - Schedule smoke runs when prod secrets missing
    - Run strict ops_daily when prod configured
    - Manual dispatch supports ci/prod modes
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - Schedule runs smoke when prod not configured
    - Schedule runs strict when prod configured
    - Manual dispatch respects mode input
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - N/A (workflow-only)
    integration:
    - ops_daily workflow smoke path succeeds without prod secrets
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Alert fatigue in non-prod environments
    - Misconfiguration of prod secrets
    mitigations:
    - Smoke mode when prod secrets missing
    - Explicit secret requirement documented
- id: T-066
  title: Second-touch offer gating parity (generation matches send guardrails)
  owner: sec
  state: DONE
  goal: Ensure second_touch offers are only generated when actionable (same guardrails as send).
  scope:
    in:
    - Apply cap/cooldown/disable/crisis guardrails at offer generation
    - Reuse shared guardrail predicate between offer and send
    - Add tests for offer suppression under each guardrail
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints:
    - GET /inbox
    data:
    - second_touch_pairs
    - second_touch_offers
    ai_calls: []
  acceptance_criteria:
    functional:
    - Offers only appear when send-time guardrails would allow
    - Offer suppression tested for cap/cooldown/disable/crisis
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No identity metadata in offer payload
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - Offer suppression tests for guardrails
    integration:
    - Inbox offer gating respects send guardrails
    security:
    - Crisis gating blocks offers
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Offers gated by send guardrails; no dead offers shown
  - All tests passing and CI green
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Confusing UX from dead offers
    - Probing via repeated blocked offers
    mitigations:
    - Shared predicate for offer/send guardrails
    - Offer suppression under cap/cooldown/disable/crisis
- id: T-067
  title: Second-touch aggregate metrics + ops_daily summary
  owner: data
  state: DONE
  goal: Add privacy-safe daily counters for second_touch and report 7d/30d summaries in ops_daily.
  scope:
    in:
    - Daily counters for offers/sends/holds/disable events (aggregate-only)
    - ops_daily 7d/30d second_touch summary output
    - Migration + CI apply for aggregates table
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data:
    - second_touch_daily_aggregates
    ai_calls: []
  acceptance_criteria:
    functional:
    - Counters updated on offer generation, suppression, send, and disable events
    - ops_daily prints 7d/30d second_touch summaries
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only counters; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - Second_touch counters update for offers/sends/holds
    integration:
    - ops_daily prints aggregate-only summary
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Daily counters persisted and reported in ops_daily
  - All tests passing and CI green (8d4c02d)
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Blind spots in guardrail tuning
    - Metrics drift without schema parity
    mitigations:
    - Aggregate-only daily counters with ops_daily summary
    - Migration applied in CI for parity
- id: T-068
  title: Second-touch health thresholds (ops_daily)
  owner: data
  state: DONE
  goal: Add low-noise second_touch health evaluator with deterministic exit codes in ops_daily.
  scope:
    in:
    - Health evaluator with low-volume gate and reasoned thresholds
    - ops_daily subcommand + included in all
    - Tests for thresholds and aggregate-only output
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - Health evaluator returns deterministic exit codes
    - Low-volume gate avoids noisy failures
    - Identity-leak disable treated as high-signal
    - ops_daily prints second_touch health summary
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only output; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - Health thresholds for low-volume/identity-leak/held/suppressed
    integration:
    - ops_daily second_touch_health output is aggregate-only
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Health thresholds added to ops_daily with low-volume gate
  - All tests passing and CI green (74a5e82)
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Alert fatigue from low-volume noise
    - Silent regressions in second_touch holds/suppression
    mitigations:
    - Insufficient-data gate; deterministic thresholds
    - Aggregate-only health checks in ops_daily
- id: T-069
  title: Ops_daily strict prod enablement
  owner: cto
  state: DONE
  goal: Run scheduled ops_daily in strict mode only when prod is configured; document enablement.
  scope:
    in:
    - Strict schedule when prod secrets present; smoke otherwise
    - Non-sensitive mode logging; no secret echo
    - README enablement docs
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - Scheduled ops_daily runs strict when prod configured
    - Scheduled ops_daily runs smoke when prod not configured
    - Manual dispatch respects mode input
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only logs; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - N/A (workflow-only)
    integration:
    - ops_daily strict/smoke gating via secret presence
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Scheduled strict/smoke behavior documented and applied
  - All tests passing and CI green (c042d85)
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Silent prod regressions if strict mode not enabled
    - Alert fatigue when prod not configured
    mitigations:
    - Secret-gated strict mode; smoke by default
    - Non-sensitive mode logging
- id: T-070
  title: Second-touch aggregates retention cleanup
  owner: data
  state: DONE
  goal: Add retention cleanup for second_touch daily aggregates with a CLI and ops_daily subcommand.
  scope:
    in:
    - 180d retention constant
    - Cleanup repository methods (in-memory + Postgres)
    - Cleanup CLI + ops_daily subcommand
    - Tests for cleanup and aggregate-only output
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data:
    - second_touch_daily_aggregates
    ai_calls: []
  acceptance_criteria:
    functional:
    - Cleanup deletes rows older than retention window
    - ops_daily cleanup subcommand prints aggregate-only line
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only output; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - Cleanup removes old day buckets
    integration:
    - Cleanup tool output is aggregate-only
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Retention cleanup implemented and documented
  - All tests passing and CI green (2f256c2)
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Unbounded aggregate growth
    - Cleanup omission leading to cost creep
    mitigations:
    - 180d retention with cleanup CLI + ops_daily subcommand
- id: T-071
  title: Production wiring runbook + db_verify
  owner: cto
  state: DONE
  goal: Document prod wiring and provide non-sensitive db_verify tooling.
  scope:
    in:
    - Prod wiring runbook (secret names only)
    - db_verify command with deterministic reason codes
    - Tests for missing DSN / missing psycopg
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - Prod wiring documented with non-sensitive verification steps
    - db_verify prints stable reason codes
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only output; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - db_verify missing_dsn / psycopg_missing reason codes
    integration:
    - db_verify output is non-sensitive
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Runbook + db_verify tooling added; deterministic reasons
  - All tests passing and CI green (4961ac6)
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Ambiguous prod setup state
    - Secret naming drift
    mitigations:
    - Runbook checklist + deterministic db_verify failure reasons
- id: T-073
  title: Ops_daily strict failure alerting
  owner: cto
  state: DONE
  goal: Add GitHub-native alerting for strict ops_daily failures with optional Slack notifications.
  scope:
    in:
    - ops_daily strict failure triggers issue creation/comment
    - Optional Slack notification when webhook secret present
    - Alert body remains aggregate-only and non-sensitive
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - Strict ops_daily failures create/update a GitHub Issue
    - Optional Slack notifications fire only when secret is set
    - Smoke mode does not alert
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only output; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - Issue body formatter avoids sensitive tokens
    integration:
    - ops_daily strict failure path emits aggregate-only alerts
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Strict failure alerting added (GitHub Issue + optional Slack)
  - All tests passing and CI green (9b29873)
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Ops failures go unnoticed
    - Alert noise in non-prod
    mitigations:
    - Strict-only alerting; smoke mode skips
    - Aggregate-only issue body
- id: T-074
  title: Ops playbook + prod verification workflow
  owner: cto
  state: DONE
  goal: Add an operator playbook and a manual prod verification workflow.
  scope:
    in:
    - Operator playbook for setup/deploy/rollback/triage
    - Manual prod_verify workflow (dry_run/verify)
    - Non-sensitive outputs only
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - Playbook documents setup, deploy, rollback, incident triage
    - prod_verify workflow runs dry_run and strict verify when configured
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only output; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - N/A (workflow/docs)
    integration:
    - Manual prod_verify workflow runs without secret echoing
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Playbook and prod_verify workflow added
  - All tests passing and CI green (5384029)
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Ad-hoc deploys without verification
    - Rollback confusion under incident
    mitigations:
    - Documented playbook and manual verification workflow
- id: T-075
  title: Recompute second_touch aggregates (last N days)
  owner: data
  state: DONE
  goal: Add an operator-driven recompute tool for second_touch daily aggregates.
  scope:
    in:
    - Recompute tool for last N days (default 7, max 30)
    - Repo method for recompute with day-window overwrite
    - ops_daily subcommand for recompute
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data:
    - second_touch_daily_aggregates
    ai_calls: []
  acceptance_criteria:
    functional:
    - Recompute overwrites in-range day buckets for reconstructable metrics
    - Output is aggregate-only and reports partial recompute when needed
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only output; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - Recompute respects day window and keeps non-recomputed keys
    integration:
    - Tool output is aggregate-only
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Recompute tool + ops_daily subcommand added
  - All tests passing and CI green (00b24db)
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Aggregate drift without recovery path
    mitigations:
    - Operator-driven recompute for last N days
- id: T-076
  title: Second-touch recompute fully reconstructable events
  owner: data
  state: DONE
  goal: Persist minimal second_touch events to allow full recompute of aggregates.
  scope:
    in:
    - second_touch_events table (event_day_utc, event_type, reason, created_at)
    - Event logging for offer/suppression/send/disable outcomes
    - Recompute uses events and becomes non-partial
    - Retention cleanup for events + ops_daily subcommand
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data:
    - second_touch_events
    ai_calls: []
  acceptance_criteria:
    functional:
    - Minimal event records persist for reconstructable metrics
    - Recompute becomes full when events available
    - Events cleanup tool removes old rows
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only output; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - Event logging + recompute matches aggregates
    - Cleanup removes old events
    integration:
    - Recompute output is aggregate-only
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Events persisted and recompute fully reconstructable
  - All tests passing and CI green (b29d4cb)
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Aggregate drift without source events
    mitigations:
    - Minimal event logging + retention cleanup
- id: T-077
  title: Security scanning + threat model doc
  owner: security
  state: DONE
  goal: Add dependency + secrets scanning in CI and document minimal threat model.
  scope:
    in:
    - Python dependency scanning (pip-audit)
    - Secrets scanning (gitleaks)
    - Minimal threat model doc
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - CI runs dependency scan and secrets scan on PR/main
    - Threat model doc added and kept non-sensitive
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only outputs; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - N/A (workflow + docs)
    integration:
    - Scanners run on CI without secret echoing
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Scanners added and threat model documented
  - All tests passing and CI green (1cf5618)
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Secret leakage in repo
    - Known dependency CVEs
    mitigations:
    - Gitleaks scan and pip-audit scan
- id: T-078
  title: Production bootstrap dry-run + operator checklist
  owner: cto
  state: DONE
  goal: Add a DB bootstrap dry-run and operator checklist for safe first-time setup.
  scope:
    in:
    - db_bootstrap dry-run migration plan validation
    - db_verify output stability for not_configured
    - CI job for bootstrap dry-run + verify
    - Operator checklist doc
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data:
    - migrations
    ai_calls: []
  acceptance_criteria:
    functional:
    - db_bootstrap --dry-run validates migration plan and is DB-free
    - db_verify outputs not_configured when DSN is missing
    - CI includes prod_bootstrap_dry_run job
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only outputs; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - db_bootstrap dry-run migration plan validation
    - db_verify not_configured output
    integration:
    - CI job runs without prod secrets
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Dry-run + docs added
  - All tests passing and CI green (e8fe580)
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Misordered or missing migrations
    - Unsafe bootstrap steps
    mitigations:
    - Dry-run validation and operator checklist
- id: T-079
  title: ops_daily insufficient_data normalization (scheduled runs)
  owner: cto
  state: DONE
  goal: De-noise scheduled ops_daily runs using explicit insufficient_data token + exit gating.
  scope:
    in:
    - ops_daily watchdog token for insufficient data
    - CI normalization helper for scheduled runs
    - Workflow gating for alerts/failures
    - Docs updates for operator guidance
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - Scheduled runs normalize only when status=insufficient_data token is present
    - Exit code 2 without token still fails
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only outputs; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - ops_ci_normalize exit gating
    - watchdog insufficient_data token
    integration:
    - Workflow normalization on schedule
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Tokenized insufficient_data output + normalization helper added
  - All tests passing and CI green (2c46591)
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Alert fatigue from zero-traffic environments
    mitigations:
    - Token-gated normalization for scheduled runs
- id: T-080
  title: Prod config contract enforcement for scheduled ops
  owner: cto
  state: IN_PROGRESS
  goal: Enforce a canonical prod config contract for scheduled ops runs.
  scope:
    in:
    - stdlib prod_config_contract helper with stable output
    - scheduled ops_daily fail-fast on missing required env names
    - operator docs updates
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - prod_config_contract exits 1 when required env names missing
    - scheduled ops_daily fails fast on missing prod config
    - PR/CI runs remain secretless and green
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Aggregate-only outputs; no identifiers or raw text
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - prod_config_contract output stability + no secret echo
    integration:
    - scheduled ops_daily enforces contract when cron
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - Prod config contract helper added
  - Scheduled ops fail-fast when missing required env
  - All tests passing and CI green
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Silent degradation to smoke runs in prod schedule
    mitigations:
    - Fail-fast contract enforcement on cron
- id: T-072
  title: DB bootstrap workflow + tool
  owner: cto
  state: DONE
  goal: Provide a manual, idempotent DB bootstrap tool and workflow with dry_run and verify.
  scope:
    in:
    - db_bootstrap tool (dry_run/apply_migrations/verify/all)
    - Manual workflow_dispatch to run bootstrap modes
    - README runbook section for bootstrap steps
    out:
    - feed
    - chat/threads
    - profiles/identity
    - streaks/leaderboards
    - social graph
  dependencies: []
  touches:
    endpoints: []
    data:
    - migrations
    ai_calls: []
  acceptance_criteria:
    functional:
    - dry_run validates config without touching DB
    - apply_migrations runs idempotently and verify checks schema
    - workflow_dispatch runs without secret echoing
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - Non-sensitive output only; no DSN echo
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
  tests:
    unit:
    - db_bootstrap dry_run missing_dsn / psycopg_missing
    integration:
    - db_bootstrap output is non-sensitive
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - db_bootstrap tool + workflow added; README bootstrap steps documented
  - All tests passing and CI green
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Ad-hoc DB setup errors
    - Migration drift during bootstrap
    mitigations:
    - Manual workflow with dry_run and verify
- id: T-024
  title: Enforce one-shot acknowledgements (idempotent + dedupe)
  owner: backend
  state: DONE
  goal: Make acknowledgement writes idempotent per recipient and prevent duplicate
    acknowledgements.
  scope:
    in:
    - Enforce one acknowledgement per recipient per inbox item
    - Make POST /acknowledgements idempotent (recorded vs already_recorded)
    - Ensure inbox ack_status stays consistent under retries
    out:
    - No app or backend behavior changes beyond ack idempotency
    - No new endpoints or schema changes unrelated to acknowledgements
    - No feed/chat/threads/profiles/identity surfaces
    - No streaks/leaderboards
  dependencies:
  - T-011
  touches:
    endpoints:
    - POST /acknowledgements
    - GET /inbox
    data:
    - acknowledgements
    ai_calls: []
  acceptance_criteria:
    functional:
    - Duplicate acknowledgements return already_recorded without new writes
    - Inbox ack_status reflects the first recorded acknowledgement
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Idempotent ack returns already_recorded on duplicate
    integration:
    - Inbox ack_status reflects acknowledgement after POST /acknowledgements
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Duplicate acknowledgements inflating metrics
    - Ack state inconsistencies under retries
    mitigations:
    - Idempotent writes and unique constraints
- id: T-025
  title: Private dashboard tab with Settings entry and About & Safety placement
  owner: frontend
  state: IN_PROGRESS
  goal: Add a private dashboard with a local display name and a Settings entry
    while keeping About & Safety last in Settings.
  scope:
    in:
    - Account tab shows a private dashboard and local display name
    - Settings entry from the account tab navigates to Settings
    - About & Safety remains last item in Settings
    - Local persistence for display name (no backend calls)
    out:
    - No backend changes or new endpoints
    - No public profile sharing
    - No feed/chat/threads/social graph
    - No streaks/leaderboards
  dependencies:
  - T-019
  touches:
    endpoints: []
    data:
    - local_display_name
    ai_calls: []
  acceptance_criteria:
    functional:
    - Profile tab shows display name when set locally
    - Settings entry opens Settings screen
    - About & Safety is last item in Settings
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - Profile shows display name from local storage
    integration:
    - Settings includes About & Safety last
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - Private identity exposed to other users
    - Local data leakage via logs
    mitigations:
    - Local-only storage and no API usage
- id: T-023
  title: CI format diff visibility + formatter patch
  owner: cto
  state: DONE
  goal: Expose formatter diffs in CI and apply formatting-only patches to keep
    the format gate green.
  scope:
    in:
    - Print formatter diffs on mismatch in CI format step
    - Apply formatting-only patches from CI diff output
    out:
    - No app or backend behavior changes
    - No endpoint changes
    - No social surfaces (feed/chat/threads/public profiles/streaks/leaderboards)
  dependencies: []
  touches:
    endpoints: []
    data: []
    ai_calls: []
  acceptance_criteria:
    functional:
    - CI logs show git status and diff on format mismatch
    - Format gate passes after applying formatting-only patch
    safety:
    - No feed/chat/profile/streak creep
    privacy:
    - No raw PII persisted
    - 'If risk_level==2: do not persist free text; crisis UX path works'
    - Crisis UX path works
    security:
    - AuthN enforced on all touched endpoints
    - 'AuthZ: user-scoped access only; no cross-user reads/writes'
    - Rate limiting enabled (per-user + per-IP) on touched endpoints
    - Request validation rejects unknown fields
    - Body + text size limits enforced
    - 'No enumeration: non-guessable IDs; no sequential IDs; safe pagination tokens'
    - Logs/analytics contain no raw message text
    - Identity leak prevention applied to outgoing text (detect->strip->rewrite->score->throttle)
  tests:
    unit:
    - N/A (workflow-only)
    integration:
    - Policy check passes
    security:
    - Cannot access another user's resources (AuthZ tests)
    - Rate limit triggers under abuse
    - Identity leak patterns are blocked/rewritten
    - risk_level==2 does not write free_text to DB
  completion_definition:
  - All tests passing
  - Safety checklist passed
  - Security checklist passed
  - No red-line violations
  threat_model:
    primary_threats:
    - CI gate drift
    - Hidden formatting diffs
    mitigations:
    - Explicit diff output in format step
